<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Color Cloud</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="x-shader/x-vertex" id="RGBVertexShader">
      uniform sampler2D tex;
      varying vec3 color;

      void main() {
      	color = texture2D ( tex, position.xy ).rgb;
      	gl_PointSize = 1.0;
      	gl_Position = projectionMatrix * modelViewMatrix * vec4(color-vec3(.5,.5,.5), 1.0);
      }
    </script>

    <script type="x-shader/x-fragment" id="RGBFragmentShader">
      varying vec3 color;

      void main() {
      	gl_FragColor.rgb = color;
      	gl_FragColor.a = 1.0;
      }
    </script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.148.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.148.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { createGrid } from "/src/Grid.js";
      import { applyWebcamBackground } from "/src/Webcam.js";
      import { onWindowResize } from "/src/Utility.js";
      import { setupGUI } from "/src/Gui.js";
      import { createPointCloud } from "/src/PointCloud.js";

      /* Main script */
      let camera, globalScene, scene, renderer, controls;

      // Video and texture
      let video, videoTexture;

      // Initialize empty scene with cameras and controls
      init();

      // Create the grid with a transparent cube
      const grid = createGrid();
      scene.add(grid);

      // Create the webcam plane
      applyWebcamBackground(scene);

      // Create the point cloud
      video = document.createElement("video");
      video.play();
      videoTexture = new THREE.VideoTexture(video);
      const points = createPointCloud(videoTexture);
      points.scale.set(255, 255, 255);
      points.position.y = 255 / 2;
      scene.add(points);

      // Setup the GUI
      setupGUI();

      // Render with setAnimationLoop for XR compatibility
      renderer.setAnimationLoop(function (time) {
        // Update controls
        controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true

        // Render
        renderer.clear();
        renderer.render(scene, camera);
      });
      /* End of main script */

      // Initialize empty scene with renderer, cameras, lights, and controls
      function init() {
        // Global scene
        scene = new THREE.Scene();

        // Renderer
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Cameras
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
        camera.position.set(255, 255, 255);

        // Controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.listenToKeyEvents(window); // optional
        controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 0;
        controls.maxDistance = 500;
        controls.target = new THREE.Vector3(0, 127.5, 0);

        // controls.autoRotate = true;
        controls.autoRotateSpeed = 1;

        // Lights
        {
          const color = 0xffffff;
          const intensity = 0.5;
          const light = new THREE.AmbientLight(color, intensity);
          light.name = "ambientLight";
          scene.add(light);
        }

        // Additional setup
        document.body.appendChild(renderer.domElement);

        // Window resize fix
        window.addEventListener("resize", onWindowResize);
        window.camera = camera;
        window.renderer = renderer;
      }
    </script>
  </body>
</html>
